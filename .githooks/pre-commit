#!/usr/bin/env bash
set -euo pipefail

# Repository pre-commit hook: run cargo fmt and refuse commit when formatting
# changes are introduced. Contributors should run the installer script once:
#   ./scripts/install-githooks.sh

echo "[pre-commit] Running cargo fmt --all"
if ! command -v cargo >/dev/null 2>&1; then
  echo "cargo not found in PATH; skipping formatting check (but you should install Rust)" >&2
  exit 0
fi

# Run rustfmt to apply any formatting fixes
cargo fmt --all

# If git working tree changed due to formatting, block the commit and show changed files
if ! git diff --exit-code --quiet; then
  echo "\n[pre-commit] Formatting changes were made by cargo fmt. Please review and stage them before committing." >&2
  echo "Files changed by rustfmt:" >&2
  git --no-pager diff --name-only
  exit 1
fi

echo "[pre-commit] Formatting OK"
exit 0
