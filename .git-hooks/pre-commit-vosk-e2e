#!/bin/bash
# Pre-commit hook to run VOSK end-to-end tests.

# Exit immediately if a command exits with a non-zero status.
set -e

echo "--- Running pre-commit hook for VOSK E2E tests ---"

# Check if we are in a headless environment.
if [[ -z "${DISPLAY:-}" && -z "${WAYLAND_DISPLAY:-}" ]]; then
    echo "[VOSK E2E] Skipping VOSK E2E test in headless environment."
    # In a headless environment, we fall back to mock tests.
    # The user wants to ensure that if VOSK fails, it's a hard failure,
    # but in a headless environment, we can't run the full E2E test.
    # The existing pre-commit hook for injection tests already handles mock tests.
    exit 0
fi

echo "[VOSK E2E] Running VOSK end-to-end test..."
# Run the specific VOSK E2E test.
# We enable the 'vosk' feature for this test.
cargo test -p coldvox-app --features vosk --lib stt::tests::end_to_end_wav::tests::test_end_to_end_wav_pipeline -- --nocapture

if [[ $? -ne 0 ]]; then
    echo "------------------------------------------------------------" >&2
    echo "ERROR: VOSK end-to-end test failed." >&2
    echo "It is VITAL that the VOSK E2E always succeeds in a workstation environment." >&2
    echo "Please review the test output above and fix the issues." >&2
    echo "------------------------------------------------------------" >&2
    exit 1
fi

echo "[VOSK E2E] VOSK end-to-end test passed."
echo "----------------------------------------------------------"
