#!/bin/bash
# Pre-commit hook to run fast, mock-only text injection tests.

# Exit immediately if a command exits with a non-zero status.
set -e

echo "--- Running pre-commit hook for text injection tests ---"

# This hook only runs the library's unit tests, which are mock-based and very fast.
# It does not require a display server or any external daemons.
echo "Running mock-only tests for coldvox-text-injection..."
cargo test -p coldvox-text-injection --lib

if [[ $? -ne 0 ]]; then
    echo "------------------------------------------------------------" >&2
    echo "ERROR: Text injection mock tests failed." >&2
    echo "This is a quick check. For full details, run the command above." >&2
    echo "------------------------------------------------------------" >&2
    exit 1
fi

echo "Mock tests passed."
echo "----------------------------------------------------------"

# Optional: Run the full suite of real, hardware-dependent injection tests.
# This requires a graphical environment and can be slow.
# To enable, set the environment variable: RUN_REAL_INJECTION_TESTS=1
if [[ "${RUN_REAL_INJECTION_TESTS:-}" == "1" ]]; then
    echo "[real] Running full real injection test suite..."
    if [[ -z "${DISPLAY:-}" && -z "${WAYLAND_DISPLAY:-}" ]]; then
        echo "[real] ERROR: Cannot run real injection tests without a display server (DISPLAY or WAYLAND_DISPLAY not set)."
        exit 1
    fi

    # Use the new cargo alias for convenience.
    if ! cargo real-injection; then
        echo "------------------------------------------------------------" >&2
        echo "ERROR: Real injection tests failed." >&2
        echo "Run 'cargo real-injection' for details." >&2
        echo "------------------------------------------------------------" >&2
        exit 1
    fi
    echo "[real] Real injection tests passed."
fi
