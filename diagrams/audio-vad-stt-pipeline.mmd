%%{init: {"theme": "base","themeVariables": {"primaryColor":"#f4f4f4","primaryTextColor":"#111","primaryBorderColor":"#666","lineColor":"#666","fontFamily":"Inter, Arial, sans-serif","fontSize":"14px"},"flowchart": {"htmlLabels": false, "curve": "linear"},"accTitle": "Audio -> VAD -> STT Pipeline","accDescr": "Detailed pipeline extracted from app/runtime and crate code; dashed items are low-confidence inferences."}}%%
flowchart LR
  subgraph Source
    CAP_DEVICE([Input Device]):::external
  end

  subgraph Capture
    CAP_THREAD[AudioCaptureThread]:::core
    RING[(AudioRingBuffer)]:::core
  end

  subgraph Chunking
    FRAME_READER[FrameReader]:::core
    CHUNKER[AudioChunker - 512 samples]:::core
  end

  subgraph VAD
    VAD_ENGINE[Silero VAD Engine]:::engine
    VAD_PROC[VadProcessor]:::engine
  end

  subgraph Fanout
    RAW_VAD_MPSC([raw_vad mpsc]):::msg
    VAD_BCAST[(vad broadcast)]:::msg
  end

  subgraph STT
  LEGACY[PluginSttProcessor legacy]:::engine
  STREAM[StreamingSttProcessor streaming]:::engine
  STT_MANAGER[SttPluginManager ?]:::maybe
  VOSK_PLUGIN[coldvox-stt-vosk ?]:::maybe
  end

  CAP_DEVICE --> CAP_THREAD --> RING
  RING --> FRAME_READER --> CHUNKER -->|f32 frames| VAD_PROC
  VAD_PROC -->|VadEvent| RAW_VAD_MPSC --> VAD_BCAST
  VAD_BCAST -->|UI| APP
  RAW_VAD_MPSC -->|fanout to| LEGACY
  CHUNKER -->|forward audio frames| LEGACY
  CHUNKER -->|forward audio->stream frames| STREAM
  RAW_VAD_MPSC -->|translate->| STREAM
  STREAM -->|events| STT_MANAGER
  LEGACY -->|events| STT_MANAGER
  STT_MANAGER -->|invoke plugin| VOSK_PLUGIN
  STT_MANAGER -.->|metrics| TELEMETRY[Telemetry]:::obs

  classDef external    fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#0b2e6f;
  classDef core        fill:#ffe0b2,stroke:#e65100,stroke-width:2px,color:#4a2a00;
  classDef engine      fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#0b3012;
  classDef msg         fill:#d9f8ef,stroke:#006e5f,stroke-width:2px,color:#083a34;
  classDef obs         fill:#eeeeee,stroke:#424242,stroke-width:2px,color:#111;
  classDef maybe       fill:#ffffff,stroke:#9e9e9e,stroke-dasharray:6 4,stroke-width:2px,color:#333;

  class CAP_DEVICE external;
  class CAP_THREAD,RING,FRAME_READER,CHUNKER core;
  class VAD_ENGINE,VAD_PROC,LEGACY,STREAM engine;
  class RAW_VAD_MPSC,VAD_BCAST msg;
  class STT_MANAGER,VOSK_PLUGIN maybe;
  class TELEMETRY obs;
