flowchart TD
    %% External inputs
    MIC[Microphone Input] --> CAPTURE[AudioCaptureThread]

    %% Ingestion & preprocessing
    CAPTURE --> CHUNKER[AudioChunker<br/>Resampler 16kHz]
    CHUNKER --> AUDIOTX{Audio TX<br/>broadcast<AudioFrame f32>}

    VADPROC[VadProcessor<br/>Silero VAD] --> RAWVADTX{Raw VAD TX<br/>mpsc<VadEvent>}

    %% Messaging / fan-out
    RAWVADTX --> VADTX[VAD TX<br/>broadcast<VadEvent> to UI]
    RAWVADTX --> FANOUT[VAD Fanout Task<br/>Streaming Mode]

    %% Core processing
    FANOUT --> STREAMVADTX{Stream VAD TX<br/>mpsc<StreamingVadEvent>}
    STREAMVADTX --> STREAMVADRX[Stream VAD RX]

    AUDIOTX --> FORWARDER[Audio Forwarder<br/>f32â†’i16 Conversion<br/>Monotonic TS]

    %% Domain engines & adapters
    PLUGINMGR[SttPluginManager<br/>Always Initialized<br/>Mock/NoOp/Whisper] -.->|load/failover| ADAPTER[ManagerStreamingAdapter<br/>Normalize Utterance IDs]

    FORWARDER -->|StreamingAudioFrame| STREAMAUDIOTX{Stream Audio TX<br/>broadcast<i16 16kHz>}
    STREAMAUDIOTX --> STREAMAUDIORX[Stream Audio RX]

    %% State / coordination
    STREAMAUDIORX --> STREAMING[StreamingSttProcessor<br/>Async Incremental<br/>Generic over StreamingStt]
    STREAMVADRX --> STREAMING
    ADAPTER --> STREAMING

    STREAMING -->|TranscriptionEvent| STTTX[STT TX<br/>mpsc<TranscriptionEvent>]

    %% Downstream consumers
    STTTX --> TUI[TUI/UI Display]
    #[cfg(feature = "text-injection")]
    STTTX --> INJECTION[Text Injection<br/>Processor]

    VADTX --> TUI

    %% Foundation components
    subgraph Foundation [Foundation Layer]
        METRICS[Metrics<br/>PipelineMetrics]
        CFG[Config<br/>AppRuntimeOptions]
        SH[Shutdown<br/>AppHandle]
        TRACING[Tracing & Logging]
    end

    %% Observability
    CHUNKER -.->|frames in/out| METRICS
    VADPROC -.->|vad events| METRICS
    FORWARDER -.->|forwarded frames| METRICS
    STREAMING -.->|partials/finals/errors| METRICS
    PLUGINMGR -.->|load/unload/errors| METRICS

    %% Shutdown & resilience
    SH -->|abort| FANOUT
    SH -->|abort| FORWARDER
    SH -->|abort| STREAMING
    SH -->|unload all| PLUGINMGR
    PLUGINMGR -.->|gc runs/failovers| METRICS

    %% Component classes
    classDef input fill:#4a90e2,stroke:#333,stroke-width:2px,color:#fff
    classDef msg fill:#50e3c2,stroke:#333,stroke-width:2px,color:#000
    classDef core fill:#f5a623,stroke:#333,stroke-width:2px,color:#000
    classDef engine fill:#7ed321,stroke:#333,stroke-width:2px,color:#000
    classDef sink fill:#bd10e0,stroke:#333,stroke-width:2px,color:#fff
    classDef ui fill:#9013fe,stroke:#333,stroke-width:2px,color:#fff
    classDef foundation fill:#d0021b,stroke:#333,stroke-width:2px,color:#fff
    classDef observability fill:#9b9b9b,stroke:#333,stroke-width:2px,color:#fff
    classDef resilience fill:#8b572a,stroke:#333,stroke-width:2px,color:#fff

    class MIC,CAPTURE input
    class AUDIOTX,RAWVADTX,VADTX,STREAMVADTX,FANOUT,STREAMAUDIOTX msg
    class CHUNKER,VADPROC,FORWARDER core
    class PLUGINMGR,ADAPTER engine
    class STREAMING core
    class TUI,INJECTION sink
    class METRICS,CFG,SH,TRACING foundation
